import{d as S}from"./chunk-PC5QHV65.js";import{$b as R,E as I,P as p,S as d,X as u,j as U,k as f,n as k,o as g,va as b,vc as h,z as x}from"./chunk-6L6IRG7H.js";var j=(()=>{class o{constructor(e,i){this.document=e,this.platformId=i,this.documentIsAccessible=h(this.platformId)}static getCookieRegExp(e){let i=e.replace(/([\[\]{}()|=;+?,.*^$])/gi,"\\$1");return new RegExp("(?:^"+i+"|;\\s*"+i+")=(.*?)(?:;|$)","g")}static safeDecodeURIComponent(e){try{return decodeURIComponent(e)}catch{return e}}check(e){return this.documentIsAccessible?(e=encodeURIComponent(e),o.getCookieRegExp(e).test(this.document.cookie)):!1}get(e){if(this.check(e)){e=encodeURIComponent(e);let s=o.getCookieRegExp(e).exec(this.document.cookie);return s&&s[1]?o.safeDecodeURIComponent(s[1]):""}else return""}getAll(){if(!this.documentIsAccessible)return{};let e={},i=this.document;return i.cookie&&i.cookie!==""&&i.cookie.split(";").forEach(s=>{let[a,n]=s.split("=");e[o.safeDecodeURIComponent(a.replace(/^ /,""))]=o.safeDecodeURIComponent(n)}),e}set(e,i,s,a,n,l,m,L){if(!this.documentIsAccessible)return;if(typeof s=="number"||s instanceof Date||a||n||l||m){let v={expires:s,path:a,domain:n,secure:l,sameSite:m||"Lax",partitioned:L};this.set(e,i,v);return}let c=encodeURIComponent(e)+"="+encodeURIComponent(i)+";",r=s||{};if(r.expires)if(typeof r.expires=="number"){let v=new Date(new Date().getTime()+r.expires*1e3*60*60*24);c+="expires="+v.toUTCString()+";"}else c+="expires="+r.expires.toUTCString()+";";r.path&&(c+="path="+r.path+";"),r.domain&&(c+="domain="+r.domain+";"),r.secure===!1&&r.sameSite==="None"&&(r.secure=!0,console.warn(`[ngx-cookie-service] Cookie ${e} was forced with secure flag because sameSite=None.More details : https://github.com/stevermeister/ngx-cookie-service/issues/86#issuecomment-597720130`)),r.secure&&(c+="secure;"),r.sameSite||(r.sameSite="Lax"),c+="sameSite="+r.sameSite+";",r.partitioned&&(c+="Partitioned;"),this.document.cookie=c}delete(e,i,s,a,n="Lax"){if(!this.documentIsAccessible)return;let l=new Date("Thu, 01 Jan 1970 00:00:01 GMT");this.set(e,"",{expires:l,path:i,domain:s,secure:a,sameSite:n})}deleteAll(e,i,s,a="Lax"){if(!this.documentIsAccessible)return;let n=this.getAll();for(let l in n)n.hasOwnProperty(l)&&this.delete(l,e,i,s,a)}static{this.\u0275fac=function(i){return new(i||o)(u(R),u(b))}}static{this.\u0275prov=d({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();var P=class o{constructor(t,e,i){this.http=t;this.cookieService=e;this.platformId=i}currentUserSubject=new f(null);currentUser$=this.currentUserSubject.asObservable();verificationPhoneNumber="";baseUrl="https://be.dabapp.co/api/";userProfileSubject=new f(null);userProfile$=this.userProfileSubject.asObservable();loggedIn=new f(this.hasToken());isLoggedIn$=this.loggedIn.asObservable();profileLoaded=!1;showLoginModalSubject=new U;loginModal$=this.showLoginModalSubject.asObservable();triggerLoginModal(){this.showLoginModalSubject.next()}login(t){return this.http.post(this.baseUrl+"login",t).pipe(p(e=>{e.requiresOTP||e.token&&(this.saveToken(e.token),this.currentUserSubject.next(e),this.setLoggedIn(!0),this.fetchUserProfile())}))}register(t){return this.http.post(this.baseUrl+"register",t).pipe(p(e=>{e.token&&(this.saveToken(e.token),this.currentUserSubject.next(e),this.setLoggedIn(!0),this.fetchUserProfile())}))}refreshToken(){return this.hasToken()?this.http.post(this.baseUrl+"refresh",{}):g(()=>new Error("No token available"))}otplogin(t){return this.http.post(this.baseUrl+"verify-otp",t).pipe(p(e=>{e.token&&(this.saveToken(e.token),this.currentUserSubject.next(e),this.setLoggedIn(!0))}))}getProfile(){return this.http.get(this.baseUrl+"me")}sendVerificationCode(){return k({success:!0}).pipe(I(500))}logout(){return this.http.post(this.baseUrl+"logout",{})}verifyCode(t){return t==="3066"?k({success:!0}).pipe(I(800),p(()=>{this.currentUserSubject.next({phoneOrEmail:this.verificationPhoneNumber,verified:!0})})):g(()=>new Error("Invalid verification code."))}saveToken(t){h(this.platformId)&&this.cookieService.set("token",t,{expires:7,secure:!1,sameSite:"Lax"})}getToken(){return h(this.platformId)&&this.cookieService.get("token")||""}getVerificationPhoneNumber(){return this.verificationPhoneNumber}setVerificationPhoneNumber(t){this.verificationPhoneNumber=t}setLoggedIn(t){this.loggedIn.next(t)}hasToken(){return!!this.getToken()}fetchUserProfileOnce(){this.getToken()&&!this.userProfileSubject.value&&this.getProfile().subscribe({next:e=>this.userProfileSubject.next(e),error:e=>console.error("Failed to fetch profile",e)})}fetchUserProfile(){this.hasToken()&&!this.profileLoaded&&this.http.get(this.baseUrl+"me").pipe(x(t=>(console.error("Failed to fetch profile",t),t.status===401&&this.handleUnauthorized(),g(()=>t)))).subscribe({next:t=>{this.userProfileSubject.next(t),this.profileLoaded=!0,console.log("Profile loaded:",t)}})}handleUnauthorized(){this.clearUserData()}clearUserData(){h(this.platformId)&&(this.cookieService.delete("token","/"),localStorage.clear(),sessionStorage.clear()),this.currentUserSubject.next(null),this.userProfileSubject.next(null),this.profileLoaded=!1,this.setLoggedIn(!1)}logoutAndClearData(){this.clearUserData()}updateUser(t){return this.http.put(this.baseUrl+"user/update",t)}verifyOtp(t,e){return this.http.post(this.baseUrl+"verify-otp",{user_id:t,otp:e}).pipe(p(i=>{console.log("Backend OTP verification response:",i),i.token&&(this.saveToken(i.token),this.currentUserSubject.next(i),this.setLoggedIn(!0))}))}requestOTP(t){return this.http.post(this.baseUrl+"request-otp",{login:t})}static \u0275fac=function(e){return new(e||o)(u(S),u(j),u(b))};static \u0275prov=d({token:o,factory:o.\u0275fac,providedIn:"root"})};export{j as a,P as b};
