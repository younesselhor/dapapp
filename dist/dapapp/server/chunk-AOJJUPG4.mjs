import './polyfills.server.mjs';
import{f as P}from"./chunk-GCKS7BR5.mjs";import{A as x,L as f,O as g,Pc as h,T as p,f as k,g as u,j as U,k as v,pc as R,sa as d,v as I}from"./chunk-FQXLIQ4O.mjs";var S=(()=>{class o{constructor(e,s){this.document=e,this.platformId=s,this.documentIsAccessible=h(this.platformId)}static getCookieRegExp(e){let s=e.replace(/([\[\]{}()|=;+?,.*^$])/gi,"\\$1");return new RegExp("(?:^"+s+"|;\\s*"+s+")=(.*?)(?:;|$)","g")}static safeDecodeURIComponent(e){try{return decodeURIComponent(e)}catch{return e}}check(e){return this.documentIsAccessible?(e=encodeURIComponent(e),o.getCookieRegExp(e).test(this.document.cookie)):!1}get(e){if(this.check(e)){e=encodeURIComponent(e);let i=o.getCookieRegExp(e).exec(this.document.cookie);return i&&i[1]?o.safeDecodeURIComponent(i[1]):""}else return""}getAll(){if(!this.documentIsAccessible)return{};let e={},s=this.document;return s.cookie&&s.cookie!==""&&s.cookie.split(";").forEach(i=>{let[a,n]=i.split("=");e[o.safeDecodeURIComponent(a.replace(/^ /,""))]=o.safeDecodeURIComponent(n)}),e}set(e,s,i,a,n,l,b,w){if(!this.documentIsAccessible)return;if(typeof i=="number"||i instanceof Date||a||n||l||b){let m={expires:i,path:a,domain:n,secure:l,sameSite:b||"Lax",partitioned:w};this.set(e,s,m);return}let c=encodeURIComponent(e)+"="+encodeURIComponent(s)+";",r=i||{};if(r.expires)if(typeof r.expires=="number"){let m=new Date(new Date().getTime()+r.expires*1e3*60*60*24);c+="expires="+m.toUTCString()+";"}else c+="expires="+r.expires.toUTCString()+";";r.path&&(c+="path="+r.path+";"),r.domain&&(c+="domain="+r.domain+";"),r.secure===!1&&r.sameSite==="None"&&(r.secure=!0,console.warn(`[ngx-cookie-service] Cookie ${e} was forced with secure flag because sameSite=None.More details : https://github.com/stevermeister/ngx-cookie-service/issues/86#issuecomment-597720130`)),r.secure&&(c+="secure;"),r.sameSite||(r.sameSite="Lax"),c+="sameSite="+r.sameSite+";",r.partitioned&&(c+="Partitioned;"),this.document.cookie=c}delete(e,s,i,a,n="Lax"){if(!this.documentIsAccessible)return;let l=new Date("Thu, 01 Jan 1970 00:00:01 GMT");this.set(e,"",{expires:l,path:s,domain:i,secure:a,sameSite:n})}deleteAll(e,s,i,a="Lax"){if(!this.documentIsAccessible)return;let n=this.getAll();for(let l in n)n.hasOwnProperty(l)&&this.delete(l,e,s,i,a)}static{this.\u0275fac=function(s){return new(s||o)(p(R),p(d))}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();var j=class o{constructor(t,e,s){this.http=t;this.cookieService=e;this.platformId=s}currentUserSubject=new u(null);currentUser$=this.currentUserSubject.asObservable();verificationPhoneNumber="";baseUrl="https://be.dabapp.co/api/";userProfileSubject=new u(null);userProfile$=this.userProfileSubject.asObservable();loggedIn=new u(this.hasToken());isLoggedIn$=this.loggedIn.asObservable();profileLoaded=!1;showLoginModalSubject=new k;loginModal$=this.showLoginModalSubject.asObservable();triggerLoginModal(){this.showLoginModalSubject.next()}login(t){return this.http.post(this.baseUrl+"login",t).pipe(f(e=>{e.requiresOTP||e.token&&(this.saveToken(e.token),this.currentUserSubject.next(e),this.setLoggedIn(!0),this.fetchUserProfile())}))}register(t){return this.http.post(this.baseUrl+"register",t).pipe(f(e=>{e.token&&(this.saveToken(e.token),this.currentUserSubject.next(e),this.setLoggedIn(!0),this.fetchUserProfile())}))}refreshToken(){return this.hasToken()?this.http.post(this.baseUrl+"refresh",{}):v(()=>new Error("No token available"))}otplogin(t){return this.http.post(this.baseUrl+"verify-otp",t).pipe(f(e=>{e.token&&(this.saveToken(e.token),this.currentUserSubject.next(e),this.setLoggedIn(!0))}))}getProfile(){return this.http.get(this.baseUrl+"me")}sendVerificationCode(){return U({success:!0}).pipe(x(500))}logout(){return this.http.post(this.baseUrl+"logout",{})}saveToken(t){h(this.platformId)&&this.cookieService.set("token",t,{expires:7,secure:!1,sameSite:"Lax"})}getToken(){return h(this.platformId)&&this.cookieService.get("token")||""}getVerificationPhoneNumber(){return this.verificationPhoneNumber}setVerificationPhoneNumber(t){this.verificationPhoneNumber=t}setLoggedIn(t){this.loggedIn.next(t)}hasToken(){return!!this.getToken()}fetchUserProfileOnce(){this.getToken()&&!this.userProfileSubject.value&&this.getProfile().subscribe({next:e=>this.userProfileSubject.next(e),error:e=>console.error("Failed to fetch profile",e)})}fetchUserProfile(){this.hasToken()&&!this.profileLoaded&&this.http.get(this.baseUrl+"me").pipe(I(t=>(console.error("Failed to fetch profile",t),t.status===401&&this.handleUnauthorized(),v(()=>t)))).subscribe({next:t=>{this.userProfileSubject.next(t),this.profileLoaded=!0}})}handleUnauthorized(){this.clearUserData()}clearUserData(){h(this.platformId)&&(this.cookieService.delete("token","/"),localStorage.clear(),sessionStorage.clear()),this.currentUserSubject.next(null),this.userProfileSubject.next(null),this.profileLoaded=!1,this.setLoggedIn(!1)}logoutAndClearData(){this.clearUserData()}updateUser(t){return this.http.put(this.baseUrl+"user/update",t)}resendOTP(t){return this.http.post(this.baseUrl+"resend-otp",t)}requestOTP(t){return this.http.post(this.baseUrl+"request-otp",{login:t})}forgotPassword(t){return this.http.post(this.baseUrl+"forgot-password",t)}resetPassword(t){return this.http.post(this.baseUrl+"reset-password",t)}setUserProfile(t){this.userProfileSubject.next(t)}getUserProfile(){return this.userProfileSubject.value}static \u0275fac=function(e){return new(e||o)(p(P),p(S),p(d))};static \u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})};export{S as a,j as b};
