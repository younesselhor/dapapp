<div class="soom-box-container">
    <div class="tabs">
        <button (click)="toggleView('received')" 
                [class]="currentView === 'received' ? 'button-style active' : 'button-style'">
            Received
        </button>
        <button (click)="toggleView('sent')" 
                [class]="currentView === 'sent' ? 'button-styleS active' : 'button-styleS'">
            Sent
        </button>
    </div>

    <div class="table-style">
        <div class="card-header">
            <div class="text-and-badge">
                <span class="text">Soom Requests</span>
                <div class="badge">
                    <span class="badge-text">
                        {{ currentView === 'received' ? receivedSooms.length : sentSooms.length }} Request{{ (currentView === 'received' ? receivedSooms.length : sentSooms.length) !== 1 ? 's' : '' }}
                    </span>
                </div>
            </div>
        </div>

        <!-- Received Tab Content -->
        <div *ngIf="currentView === 'received'">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th class="header-text">Ad Name</th>
                            <th class="header-text text-right">Country</th>
                            <th class="header-text text-right">Amount</th>
                            <th class="header-text text-right">Status</th>
                            <th class="header-text text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <ng-container *ngFor="let soom of receivedSooms; let last = last">
                            <tr>
                                <td class="table-cell-content">
                                    <div class="text-and-supp">
                                        <span class="table-title">{{ soom.listing.title }}</span>

                                        <ng-container *ngIf="getDaysLeft(soom.submission_date) > 1">
                                            <small class="morethanone">
                                                Expires in {{ getDaysLeft(soom.submission_date) }} days
                                            </small>
                                        </ng-container>

                                        <ng-container *ngIf="getDaysLeft(soom.submission_date) === 1">
                                            <small class="oneday">
                                                Expires in {{ getDaysLeft(soom.submission_date) }} day
                                            </small>
                                        </ng-container>
                                         <ng-container *ngIf="getDaysLeft(soom.submission_date) <= 0">
                                            <small class="expired">
                                                Expired
                                            </small>
                                        </ng-container>
                                    </div>
                                </td>

                                <td class="table-cell-content country-cell text-right">
                                    {{ soom.listing.city?.name || "N/A" }}
                                </td>

                                <td class="table-cell-content price-cell text-right">
                                    {{ soom.amount }} SAR
                                </td>

                                <td class="table-cell-content text-right">
                                    <span *ngIf="soom.status === 'accepted'" class="accepted">
                                        Accepted
                                    </span>
                                    <span *ngIf="soom.status === 'rejected'" class="rejected">
                                        Rejected
                                    </span>
                                    <span *ngIf="soom.status === 'pending'" class="status-pending">
                                        Pending
                                    </span>
                                    <span *ngIf="soom.listing.listing_status === 'sold'" class="status-sold">
                                        Sold
                                    </span>
                                    <span *ngIf="soom.listing.listing_status === 'closed'" class="status-closed">
                                        Closed
                                    </span>
                                </td>

                                <td class="table-cell-content text-right">
                                    <!-- Pending: Show Accept/Reject buttons -->
                                    <div *ngIf="soom.status === 'pending'" class="action">
                                        <button (click)="rejectSoom(soom)" class="action-btn reject-btn" title="Reject">
                                            ✗
                                        </button>
                                        <button (click)="openAcceptModal(soom)" class="action-btn accept-btn" title="Accept">
                                            ✓
                                        </button>
                                    </div>

                                    <!-- Accepted: Show sale action buttons -->
                                    <div *ngIf="soom.status === 'accepted' && !soom.sale_validated" class="action-buttons">
                                        <button (click)="validateSale(soom)" class="validate-sale-btn" title="Validate Sale">
                                            Validate Sale
                                        </button>
                                    </div>

                                    <!-- After validate sale: Show Mark as Sold and Close -->
                                    <div *ngIf="soom.status === 'accepted' && soom.sale_validated && soom.listing.listing_status !== 'sold' && soom.listing.listing_status !== 'closed'" class="action-buttons-group">
                                        <button (click)="markAsSold(soom)" class="mark-sold-btn" title="Mark as Sold">
                                            Mark as Sold
                                        </button>
                                        <button (click)="closeListing(soom)" class="close-btn-action" title="Close">
                                            Close
                                        </button>
                                    </div>

                                    <!-- After mark as sold: Show only Close -->
                                    <div *ngIf="soom.listing.listing_status === 'sold'" class="action-buttons">
                                        <button (click)="closeListing(soom)" class="close-btn-action" title="Close">
                                            Close
                                        </button>
                                    </div>

                                    <!-- After close: Show Reopen -->
                                    <div *ngIf="soom.listing.listing_status === 'closed'" class="action-buttons">
                                        <button (click)="reopenListing(soom)" class="reopen-btn" title="Reopen">
                                            Reopen
                                        </button>
                                    </div>

                                    <!-- Rejected: Show dash -->
                                    <span *ngIf="soom.status === 'rejected'">-</span>
                                </td>
                            </tr>

                            <tr *ngIf="!last" class="divider-row">
                                <td colspan="5">
                                    <div class="divider"></div>
                                </td>
                            </tr>
                        </ng-container>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Sent Tab Content (unchanged) -->
        <div *ngIf="currentView === 'sent'">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th class="header-text">Ad Name</th>
                            <th class="header-text text-right">Country</th>
                            <th class="header-text text-right">Amount</th>
                            <th class="header-text text-right">Status</th>
                            <th class="header-text text-right">Seller Information</th>
                        </tr>
                    </thead>
                    <tbody>
                        <ng-container *ngFor="let soom of sentSooms; let last = last">
                            <tr>
                                <td class="table-cell-content">
                                    <div class="text-and-supp">
                                        <span class="table-title">{{ soom.listing.title }}</span>

                                        <ng-container *ngIf="getDaysLeft(soom.submission_date) > 1">
                                            <small class="morethanone">
                                                Expires in {{ getDaysLeft(soom.submission_date) }} days
                                            </small>
                                        </ng-container>

                                        <ng-container *ngIf="getDaysLeft(soom.submission_date) === 1">
                                            <small class="oneday">
                                                Expires in {{ getDaysLeft(soom.submission_date) }} day
                                            </small>
                                        </ng-container>

                                        <ng-container *ngIf="isExpired(soom.submission_date)">
                                            <button class="btn-soom">
                                                Submit another Soom
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                                                    viewBox="0 0 20 20" fill="none">
                                                    <path
                                                        d="M4.16602 10.0001H15.8327M15.8327 10.0001L9.99935 4.16675M15.8327 10.0001L9.99935 15.8334"
                                                        stroke="#1852F1" stroke-width="1.67" stroke-linecap="round"
                                                        stroke-linejoin="round" />
                                                </svg>
                                            </button>
                                        </ng-container>
                                    </div>
                                </td>

                                <td class="table-cell-content country-cell text-right">
                                    {{ soom.listing.city?.name || "N/A" }}
                                </td>

                                <td class="table-cell-content price-cell text-right">
                                    {{ soom.amount }} SAR
                                </td>

                                <td class="table-cell-content text-right">
                                    <ng-container [ngSwitch]="soom.status">
                                        <span *ngSwitchCase="'accepted'" class="status-accepted">
                                            Accepted
                                        </span>
                                        <span *ngSwitchCase="'rejected'" class="status-rejected">
                                            Rejected
                                        </span>
                                        <span *ngSwitchDefault [class]="isExpired(soom.submission_date) ? 'status-expired' : 'status-pending'">
                                            {{ isExpired(soom.submission_date) ? 'Expired' : 'Pending' }}
                                        </span>
                                    </ng-container>
                                </td>

                                <td class="table-cell-content text-right seller-info-cell">
                                    <button *ngIf="soom.status === 'accepted'" class="view-seller-info-btn" (click)="viewSellerInfo(soom)">
                                        View Seller Info
                                    </button>
                                    <span *ngIf="soom.status !== 'accepted'">-</span>
                                </td>
                            </tr>

                            <tr *ngIf="!last" class="divider-row">
                                <td colspan="5">
                                    <div class="divider"></div>
                                </td>
                            </tr>
                        </ng-container>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        <div class="pagination">
            <div class="pagination-content">
                <div class="btn-prev">
                    <button class="btn-left">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 14 14" fill="none">
                            <path
                                d="M12.8327 7.00008H1.16602M1.16602 7.00008L6.99935 12.8334M1.16602 7.00008L6.99935 1.16675"
                                stroke="#344054" stroke-width="1.67" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <span class="text-btn-left">Previous</span>
                    </button>
                </div>

                <div class="right-content-pagination">
                    <div class="number-of-page">
                        <span class="show">Show</span>
                        <div class="dropdown-container">
                            <div class="dropdown-wrapper">
                                <button class="dropdown-button" (click)="toggleDropdown()">
                                    <span class="dropdown-number">28</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="8" viewBox="0 0 12 8"
                                        fill="none">
                                        <path d="M1 1.5L6 6.5L11 1.5" stroke="#344054" stroke-width="1.67"
                                            stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </button>

                                <div class="dropdown-menu" *ngIf="isDropdownOpen">
                                    <div class="dropdown-item" (click)="selectNumber(10)">10</div>
                                    <div class="dropdown-item" (click)="selectNumber(20)">20</div>
                                    <div class="dropdown-item" (click)="selectNumber(30)">30</div>
                                    <div class="dropdown-item" (click)="selectNumber(50)">50</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="btn-next">
                        <button class="btn-right">
                            <span class="text-btn-right">Next</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 14 14"
                                fill="none">
                                <path
                                    d="M1.16602 7.00008H12.8327M12.8327 7.00008L6.99935 1.16675M12.8327 7.00008L6.99935 12.8334"
                                    stroke="#344054" stroke-width="1.67" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Accept Confirmation Modal (unchanged) -->
<div class="modal-backdrop" *ngIf="showAcceptModal" (click)="closeModal()">
    <div class="modal" (click)="$event.stopPropagation()">
        <div class="top-content-modal">
            <div class="svg-modal">
                <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 26 26" fill="none">
                    <path d="M13.0007 8.3335C14.9336 8.3335 16.5007 6.76649 16.5007 4.8335C16.5007 2.9005 14.9336 1.3335 13.0007 1.3335C11.0677 1.3335 9.50065 2.9005 9.50065 4.8335C9.50065 6.76649 11.0677 8.3335 13.0007 8.3335ZM13.0007 8.3335V24.6668M13.0007 24.6668C9.90646 24.6668 6.939 23.4377 4.75107 21.2497C2.56315 19.0618 1.33398 16.0944 1.33398 13.0002H4.83398M13.0007 24.6668C16.0948 24.6668 19.0623 23.4377 21.2502 21.2497C23.4382 19.0618 24.6673 16.0944 24.6673 13.0002H21.1673" stroke="#F03D24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>

            <div class="text-top-modal">
                <span class="price-modal">{{ selectedSoom?.amount }} SAR</span>
                <span class="user-made">
                    {{ selectedSoom?.user?.first_name }} {{ selectedSoom?.user?.last_name }} made a soom request
                </span>
                <span class="expired-date-modal">
                    <ng-container *ngIf="selectedSoom && getDaysLeft(selectedSoom.submission_date) > 1">
                        Expires in {{ getDaysLeft(selectedSoom.submission_date) }} days
                    </ng-container>
                    <ng-container *ngIf="selectedSoom && getDaysLeft(selectedSoom.submission_date) === 1">
                        Expires in 1 day
                    </ng-container>
                </span>
            </div>
        </div>

        <div class="product-card-modal">
            <img [src]="selectedSoom?.first_image || selectedSoom?.listing?.images?.[0]?.image_url" alt="Product" class="img-card-modal">
            <div class="content-modal">
                <div class="name-description">
                    <span class="name-product-modal">{{ selectedSoom?.listing?.title }}</span>
                    <span class="description-product-modal">
                        Min. amount to offer: {{ selectedSoom?.min_soom }} SAR
                    </span>
                </div>
            </div>
        </div>

        <div>
            <p class="text-modal">
                By confirming, we will put your ad on hold and send your information to the buyer to
                communicate with you. If you deny, the buyer has to request again.
            </p>
        </div>

        <div class="button-section">
            <div class="btn-sec">
                <button class="reject-btn-modal" (click)="rejectSoom(selectedSoom!)">
                    <span class="reject-text">Reject</span>
                </button>

                <button class="accept-btn-modal" (click)="confirmAcceptSoom()">
                   Accept
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Accepted Confirmation Modal (unchanged) -->
<div class="modal-backdrop" *ngIf="showAcceptedModal" (click)="closeAcceptedModal()">
    <div class="modal" (click)="$event.stopPropagation()">
        <div class="top-content-modal">
            <div class="svg-modal-accept">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 22 22" fill="none">
                    <path d="M21 10.0799V10.9999C20.9988 13.1563 20.3005 15.2545 19.0093 16.9817C17.7182 18.7088 15.9033 19.9723 13.8354 20.5838C11.7674 21.1952 9.55726 21.1218 7.53447 20.3744C5.51168 19.6271 3.78465 18.246 2.61096 16.4369C1.43727 14.6279 0.879791 12.4879 1.02168 10.3362C1.16356 8.18443 1.99721 6.13619 3.39828 4.49694C4.79935 2.85768 6.69279 1.71525 8.79619 1.24001C10.8996 0.764774 13.1003 0.982201 15.07 1.85986M21 2.99986L11 13.0099L8.00001 10.0099" stroke="#086A47" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>

            <div class="text-top-modal">
                <span class="soom-modal-accepted">Soom Request accepted</span>
                <span class="user-contact-text">
                    Your contact information will be sent to this customer to contact you
                </span>
            </div>
        </div>
        
        <div class="user-made-soom">
            <div class="avatar">
                {{ getInitials(selectedSoom?.user?.first_name, selectedSoom?.user?.last_name) }}
            </div>
            <div class="user-name">
                {{ selectedSoom?.user?.first_name}} {{ selectedSoom?.user?.last_name}}
            </div>
            <div class="price-made">
                {{selectedSoom?.amount}}Sar
            </div>
        </div>

        <div class="product-card-modal">
            <img [src]="selectedSoom?.first_image || selectedSoom?.listing?.images?.[0]?.image_url" alt="Product" class="img-card-modal">
            <div class="content-modal">
                <div class="name-description">
                    <span class="name-product-modal">{{ selectedSoom?.listing?.title }}</span>
                    <span class="description-product-modal">
                        Min. amount to offer: {{ selectedSoom?.min_soom }} SAR
                    </span>
                </div>
            </div>
        </div>

        <div class="close-btn-modal">
            <button class="btn-close" (click)="closeAcceptedModal()">Close</button>
        </div>
    </div>
</div>