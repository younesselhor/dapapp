import{d as P}from"./chunk-Z35ZOHGZ.js";import{A as x,F as U,Q as a,T as b,Y as u,ac as R,j as I,k as f,o as k,p as g,wa as d,wc as p}from"./chunk-EHK7OZ2L.js";var S=(()=>{class o{constructor(e,i){this.document=e,this.platformId=i,this.documentIsAccessible=p(this.platformId)}static getCookieRegExp(e){let i=e.replace(/([\[\]{}()|=;+?,.*^$])/gi,"\\$1");return new RegExp("(?:^"+i+"|;\\s*"+i+")=(.*?)(?:;|$)","g")}static safeDecodeURIComponent(e){try{return decodeURIComponent(e)}catch{return e}}check(e){return this.documentIsAccessible?(e=encodeURIComponent(e),o.getCookieRegExp(e).test(this.document.cookie)):!1}get(e){if(this.check(e)){e=encodeURIComponent(e);let r=o.getCookieRegExp(e).exec(this.document.cookie);return r&&r[1]?o.safeDecodeURIComponent(r[1]):""}else return""}getAll(){if(!this.documentIsAccessible)return{};let e={},i=this.document;return i.cookie&&i.cookie!==""&&i.cookie.split(";").forEach(r=>{let[c,n]=r.split("=");e[o.safeDecodeURIComponent(c.replace(/^ /,""))]=o.safeDecodeURIComponent(n)}),e}set(e,i,r,c,n,h,m,L){if(!this.documentIsAccessible)return;if(typeof r=="number"||r instanceof Date||c||n||h||m){let v={expires:r,path:c,domain:n,secure:h,sameSite:m||"Lax",partitioned:L};this.set(e,i,v);return}let l=encodeURIComponent(e)+"="+encodeURIComponent(i)+";",s=r||{};if(s.expires)if(typeof s.expires=="number"){let v=new Date(new Date().getTime()+s.expires*1e3*60*60*24);l+="expires="+v.toUTCString()+";"}else l+="expires="+s.expires.toUTCString()+";";s.path&&(l+="path="+s.path+";"),s.domain&&(l+="domain="+s.domain+";"),s.secure===!1&&s.sameSite==="None"&&(s.secure=!0,console.warn(`[ngx-cookie-service] Cookie ${e} was forced with secure flag because sameSite=None.More details : https://github.com/stevermeister/ngx-cookie-service/issues/86#issuecomment-597720130`)),s.secure&&(l+="secure;"),s.sameSite||(s.sameSite="Lax"),l+="sameSite="+s.sameSite+";",s.partitioned&&(l+="Partitioned;"),this.document.cookie=l}delete(e,i,r,c,n="Lax"){if(!this.documentIsAccessible)return;let h=new Date("Thu, 01 Jan 1970 00:00:01 GMT");this.set(e,"",{expires:h,path:i,domain:r,secure:c,sameSite:n})}deleteAll(e,i,r,c="Lax"){if(!this.documentIsAccessible)return;let n=this.getAll();for(let h in n)n.hasOwnProperty(h)&&this.delete(h,e,i,r,c)}static{this.\u0275fac=function(i){return new(i||o)(u(R),u(d))}}static{this.\u0275prov=b({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();var j=class o{constructor(t,e,i){this.http=t;this.cookieService=e;this.platformId=i}currentUserSubject=new f(null);currentUser$=this.currentUserSubject.asObservable();verificationPhoneNumber="";baseUrl="https://be.dabapp.co/api/";userProfileSubject=new f(null);userProfile$=this.userProfileSubject.asObservable();loggedIn=new f(this.hasToken());isLoggedIn$=this.loggedIn.asObservable();profileLoaded=!1;showLoginModalSubject=new I;loginModal$=this.showLoginModalSubject.asObservable();triggerLoginModal(){this.showLoginModalSubject.next()}login(t){return this.http.post(this.baseUrl+"login",t).pipe(a(e=>{e.requiresOTP||e.token&&(this.saveToken(e.token),this.currentUserSubject.next(e),this.setLoggedIn(!0),this.fetchUserProfile())}))}register(t){return this.http.post(this.baseUrl+"register",t).pipe(a(e=>{e.token&&(this.saveToken(e.token),this.currentUserSubject.next(e),this.setLoggedIn(!0),this.fetchUserProfile())}))}refreshToken(){return this.hasToken()?this.http.post(this.baseUrl+"refresh",{}):g(()=>new Error("No token available"))}otplogin(t){return this.http.post(this.baseUrl+"verify-otp",t).pipe(a(e=>{e.token&&(this.saveToken(e.token),this.currentUserSubject.next(e),this.setLoggedIn(!0))}))}getProfile(){return this.http.get(this.baseUrl+"me")}sendVerificationCode(){return k({success:!0}).pipe(U(500))}logout(){return this.http.post(this.baseUrl+"logout",{})}verifyCode(t){return t==="3066"?k({success:!0}).pipe(U(800),a(()=>{this.currentUserSubject.next({phoneOrEmail:this.verificationPhoneNumber,verified:!0})})):g(()=>new Error("Invalid verification code."))}saveToken(t){p(this.platformId)&&this.cookieService.set("token",t,{expires:7,secure:!1,sameSite:"Lax"})}getToken(){return p(this.platformId)&&this.cookieService.get("token")||""}getVerificationPhoneNumber(){return this.verificationPhoneNumber}setVerificationPhoneNumber(t){this.verificationPhoneNumber=t}setLoggedIn(t){this.loggedIn.next(t)}hasToken(){return!!this.getToken()}fetchUserProfileOnce(){this.getToken()&&!this.userProfileSubject.value&&this.getProfile().subscribe({next:e=>this.userProfileSubject.next(e),error:e=>console.error("Failed to fetch profile",e)})}fetchUserProfile(){this.hasToken()&&!this.profileLoaded&&this.http.get(this.baseUrl+"me").pipe(x(t=>(console.error("Failed to fetch profile",t),t.status===401&&this.handleUnauthorized(),g(()=>t)))).subscribe({next:t=>{this.userProfileSubject.next(t),this.profileLoaded=!0,console.log("Profile loaded:",t)}})}handleUnauthorized(){this.clearUserData()}clearUserData(){p(this.platformId)&&(this.cookieService.delete("token","/"),localStorage.clear(),sessionStorage.clear()),this.currentUserSubject.next(null),this.userProfileSubject.next(null),this.profileLoaded=!1,this.setLoggedIn(!1)}logoutAndClearData(){this.clearUserData()}updateUser(t){return this.http.put(this.baseUrl+"user/update",t)}loginWithFirebaseToken(t){return this.http.post(this.baseUrl+"firebase-login",{idToken:t})}loginWithEmailPassword(t,e){return this.http.post(this.baseUrl+"login",{login:t,password:e}).pipe(a(i=>{i.requiresOTP||i.token&&(this.saveToken(i.token),this.currentUserSubject.next(i),this.setLoggedIn(!0),this.fetchUserProfile())}))}loginWithPhonePassword(t,e){return this.http.post(this.baseUrl+"login-phone-password",{phone:t,password:e}).pipe(a(i=>{console.log("Phone login response:",i)}))}verifyOtp(t,e){return this.http.post(this.baseUrl+"verify-otp",{user_id:t,otp:e}).pipe(a(i=>{console.log("Backend OTP verification response:",i),i.token&&(this.saveToken(i.token),this.currentUserSubject.next(i),this.setLoggedIn(!0))}))}completeFirebaseAuth(t,e){return this.http.post(this.baseUrl+"complete-firebase-auth",{user_id:t,idToken:e}).pipe(a(i=>{console.log("Firebase auth completion response:",i),i.token&&(this.saveToken(i.token),this.currentUserSubject.next(i),this.setLoggedIn(!0),this.fetchUserProfile())}))}requestOTP(t){return this.http.post(this.baseUrl+"request-otp",{login:t})}static \u0275fac=function(e){return new(e||o)(u(P),u(S),u(d))};static \u0275prov=b({token:o,factory:o.\u0275fac,providedIn:"root"})};export{S as a,j as b};
